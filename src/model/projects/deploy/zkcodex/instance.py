import asyncio
import random
import hashlib
import time
import os

from eth_account import Account
from src.model.onchain.web3_custom import Web3Custom
from loguru import logger
import primp
from web3 import Web3
from src.utils.decorators import retry_async
from src.utils.config import Config
from src.utils.constants import EXPLORER_URL_MEGAETH

CHAIN_ID = 6342  # From constants.py comment


class ZkCodex:
    def __init__(
        self,
        account_index: int,
        session: primp.AsyncClient,
        web3: Web3Custom,
        config: Config,
        wallet: Account,
        private_key: str,
    ):
        self.account_index = account_index
        self.session = session
        self.web3 = web3
        self.config = config
        self.wallet = wallet
        self.private_key = private_key

    @retry_async(default_value=False)
    async def deploy_default_contract(self):
        try:
            logger.info(f"[{self.account_index}] Deploying default contract")

            # Contract bytecode (the input data from the example transaction)
            bytecode = "0x60c0604052601960809081527f48656c6c6f20576f726c642077697468207a6b436f646578210000000000000060a05260009061003c90826100ee565b5034801561004957600080fd5b506101ac565b634e487b7160e01b600052604160045260246000fd5b600181811c9082168061007957607f821691505b60208210810361009957634e487b7160e01b600052602260045260246000fd5b50919050565b601f8211156100e957806000526020600020601f840160051c810160208510156100c65750805b601f840160051c820191505b818110156100e657600081556001016100d2565b50505b505050565b81516001600160401b038111156101075761010761004f565b61011b816101158454610065565b8461009f565b6020601f82116001811461014f57600083156101375750848201515b600019600385901b1c1916600184901b1784556100e6565b600084815260208120601f198516915b8281101561017f578785015182556020948501946001909201910161015f565b508482101561019d5786840151600019600387901b60f8161c191681555b50505050600190811b01905550565b61019a806101bb6000396000f3fe608060405234801561001057600080fd5b506004361061002b5760003560e01c8063e21f37ce14610030575b600080fd5b61003861004e565b60405161004591906100dc565b60405180910390f35b6000805461005b9061012a565b80601f01602080910402602001604051908101604052809291908181526020018280546100879061012a565b80156100d45780601f106100a9576101008083540402835291602001916100d4565b820191906000526020600020905b8154815290600101906020018083116100b757829003601f168201915b505050505081565b602081526000825180602084015260005b8181101561010a57602081860181015160408684010152016100ed565b506000604082850101526040601f19601f83011684010191505092915050565b600181811c9082168061013e57607f821691505b60208210810361015e57634e487b7160e01b600052602260045260246000fd5b5091905056fea26469706673582212203d434d68b8007847cc10a8727fe15ae7f57d189b44304c553bef7118d806703a64736f6c634300081a0033000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000d3c21bcecceda100000000000000000000000000000000000000000000000000000000000000000000167a6b436f64657820546f6b656e204465706c6f7965720000000000000000000000000000000000000000000000000000000000000000000000000000000000075a4b434f44455800000000000000000000000000000000000000000000000000"

            # Create transaction for gas estimation
            transaction = {
                "from": self.wallet.address,
                "to": None,  # Contract creation has no 'to' address
                "value": self.web3.web3.to_wei(0, "ether"),
                "data": bytecode,
            }

            # Estimate gas
            try:
                gas_limit = await self.web3.estimate_gas(transaction)
                transaction["gas"] = gas_limit
            except Exception as gas_error:
                logger.error(
                    f"[{self.account_index}] Gas estimation error: {gas_error}"
                )
                raise gas_error

            # Get gas price parameters
            gas_params = await self.web3.get_gas_params()
            transaction.update(gas_params)

            # Add chain ID and nonce
            transaction["chainId"] = CHAIN_ID
            transaction["nonce"] = await self.web3.web3.eth.get_transaction_count(
                self.wallet.address
            )

            # Sign transaction
            signed_txn = self.web3.web3.eth.account.sign_transaction(
                transaction, self.private_key
            )

            # Send transaction
            tx_hash = await self.web3.web3.eth.send_raw_transaction(
                signed_txn.raw_transaction
            )

            # Wait for confirmation
            receipt = await self.web3.web3.eth.wait_for_transaction_receipt(tx_hash)

            if receipt["status"] == 1:
                contract_address = receipt.contractAddress
                logger.success(
                    f"[{self.account_index}] Successfully deployed contract at {contract_address}. TX: {EXPLORER_URL_MEGAETH}{tx_hash.hex()}"
                )
                return True, contract_address
            else:
                logger.error(
                    f"[{self.account_index}] Contract deployment failed. TX: {EXPLORER_URL_MEGAETH}{tx_hash.hex()}"
                )
                return False, None

        except Exception as e:
            random_pause = random.randint(
                self.config.SETTINGS.RANDOM_PAUSE_BETWEEN_ACTIONS[0],
                self.config.SETTINGS.RANDOM_PAUSE_BETWEEN_ACTIONS[1],
            )
            logger.error(
                f"[{self.account_index}] Error deploying contract: {e}. Pause {random_pause} seconds"
            )
            await asyncio.sleep(random_pause)
            raise

    async def deploy_token(
        self,
        token_name="zkCodex Token Deployer",
        token_symbol="ZKCODEX",
        total_supply=1000000,
    ):
        for retry in range(self.config.SETTINGS.ATTEMPTS):
            try:
                logger.info(
                    f"[{self.account_index}] Deploying token contract: {token_name} ({token_symbol})"
                )

                # Token contract bytecode
                bytecode = "0x608060405234801561001057600080fd5b50604051610e3a380380610e3a83398101604081905261002f9161039d565b338383600361003e8382610498565b50600461004b8282610498565b5050506001600160a01b03811661007d57604051631e4fbdf760e01b8152600060048201526024015b60405180910390fd5b61008681610124565b50600081116100d75760405162461bcd60e51b815260206004820152601d60248201527f537570706c79206d7573742062652067726561746572207468616e20300000006044820152606401610074565b6100e13382610176565b7f35d0b9713cc4b54bb91a9bfa420b091d37c592d49a7468dafe20b4cfbdfca02a83838360405161011493929190610582565b60405180910390a15050506105df565b600580546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e090600090a35050565b6001600160a01b0382166101a05760405163ec442f0560e01b815260006004820152602401610074565b6101ac600083836101b0565b5050565b6001600160a01b0383166101db5780600260008282546101d091906105b8565b9091555061024d9050565b6001600160a01b0383166000908152602081905260409020548181101561022e5760405163391434e360e21b81526001600160a01b03851660048201526024810182905260448101839052606401610074565b6001600160a01b03841660009081526020819052604090209082900390555b6001600160a01b03821661026957600280548290039055610288565b6001600160a01b03821660009081526020819052604090208054820190555b816001600160a01b0316836001600160a01b03167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040516102cd91815260200190565b60405180910390a3505050565b634e487b7160e01b600052604160045260246000fd5b60005b8381101561030b5781810151838201526020016102f3565b50506000910152565b600082601f83011261032557600080fd5b81516001600160401b0381111561033e5761033e6102da565b604051601f8201601f19908116603f011681016001600160401b038111828210171561036c5761036c6102da565b60405281815283820160200185101561038457600080fd5b6103958260208301602087016102f0565b949350505050565b6000806000606084860312156103b257600080fd5b83516001600160401b038111156103c857600080fd5b6103d486828701610314565b602086015190945090506001600160401b038111156103f257600080fd5b6103fe86828701610314565b925050604084015190509250925092565b600181811c9082168061042357607f821691505b60208210810361044357634e487b7160e01b600052602260045260246000fd5b50919050565b601f82111561049357806000526020600020601f840160051c810160208510156104705750805b601f840160051c820191505b81811015610490576000815560010161047c565b50505b505050565b81516001600160401b038111156104b1576104b16102da565b6104c5816104bf845461040f565b84610449565b6020601f8211600181146104f957600083156104e15750848201515b600019600385901b1c1916600184901b178455610490565b600084815260208120601f198516915b828110156105295787850151825560209485019460019092019101610509565b50848210156105475786840151600019600387901b60f8161c191681555b50505050600190811b01905550565b6000815180845261056e8160208601602086016102f0565b601f01601f19169290920160200192915050565b6060815260006105956060830186610556565b82810360208401526105a78186610556565b915050826040830152949350505050565b808201808211156105d957634e487b7160e01b600052601160045260246000fd5b92915050565b61084c806105ee6000396000f3fe608060405234801561001057600080fd5b50600436106100b45760003560e01c8063715018a611610071578063715018a6146101575780638da5cb5b1461016157806395d89b411461017c578063a9059cbb14610184578063dd62ed3e14610197578063f2fde38b146101d057600080fd5b806306fdde03146100b9578063095ea7b3146100d757806318160ddd146100fa57806323b872dd1461010c578063313ce5671461011f57806370a082311461012e575b600080fd5b6100c16101e3565b6040516100ce9190610695565b60405180910390f35b6100ea6100e53660046106ff565b610275565b60405190151581526020016100ce565b6002545b6040519081526020016100ce565b6100ea61011a366004610729565b61028f565b604051601281526020016100ce565b6100fe61013c366004610766565b6001600160a01b031660009081526020819052604090205490565b61015f6102b3565b005b6005546040516001600160a01b0390911681526020016100ce565b6100c16102c7565b6100ea6101923660046106ff565b6102d6565b6100fe6101a5366004610788565b6001600160a01b03918216600090815260016020908152604080832093909416825291909152205490565b61015f6101de366004610766565b6102e4565b6060600380546101f2906107bb565b80601f016020809104026020016040519081016040528092919081815260200182805461021e906107bb565b801561026b5780601f106102405761010080835404028352916020019161026b565b820191906000526020600020905b81548152906001019060200180831161024e57829003601f168201915b5050505050905090565b600033610283818585610327565b60019150505b92915050565b60003361029d858285610339565b6102a88585856103b8565b506001949350505050565b6102bb610417565b6102c56000610444565b565b6060600480546101f2906107bb565b6000336102838185856103b8565b6102ec610417565b6001600160a01b03811661031b57604051631e4fbdf760e01b8152600060048201526024015b60405180910390fd5b61032481610444565b50565b6103348383836001610496565b505050565b6001600160a01b038381166000908152600160209081526040808320938616835292905220546000198110156103b257818110156103a357604051637dc7a0d960e11b81526001600160a01b03841660048201526024810182905260448101839052606401610312565b6103b284848484036000610496565b50505050565b6001600160a01b0383166103e257604051634b637e8f60e11b815260006004820152602401610312565b6001600160a01b03821661040c5760405163ec442f0560e01b815260006004820152602401610312565b61033483838361056b565b6005546001600160a01b031633146102c55760405163118cdaa760e01b8152336004820152602401610312565b600580546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e090600090a35050565b6001600160a01b0384166104c05760405163e602df0560e01b815260006004820152602401610312565b6001600160a01b0383166104ea57604051634a1406b160e11b815260006004820152602401610312565b6001600160a01b03808516600090815260016020908152604080832093871683529290522082905580156103b257826001600160a01b0316846001600160a01b03167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9258460405161055d91815260200190565b60405180910390a350505050565b6001600160a01b03831661059657806002600082825461058b91906107f5565b909155506106089050565b6001600160a01b038316600090815260208190526040902054818110156105e95760405163391434e360e21b81526001600160a01b03851660048201526024810182905260448101839052606401610312565b6001600160a01b03841660009081526020819052604090209082900390555b6001600160a01b03821661062457600280548290039055610643565b6001600160a01b03821660009081526020819052604090208054820190555b816001600160a01b0316836001600160a01b03167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef8360405161068891815260200190565b60405180910390a3505050565b602081526000825180602084015260005b818110156106c357602081860181015160408684010152016106a6565b506000604082850101526040601f19601f83011684010191505092915050565b80356001600160a01b03811681146106fa57600080fd5b919050565b6000806040838503121561071257600080fd5b61071b836106e3565b946020939093013593505050565b60008060006060848603121561073e57600080fd5b610747846106e3565b9250610755602085016106e3565b929592945050506040919091013590565b60006020828403121561077857600080fd5b610781826106e3565b9392505050565b6000806040838503121561079b57600080fd5b6107a4836106e3565b91506107b2602084016106e3565b90509250929050565b600181811c908216806107cf57607f821691505b6020821081036107ef57634e487b7160e01b600052602260045260246000fd5b50919050565b8082018082111561028957634e487b7160e01b600052601160045260246000fdfea2646970667358221220ee335cbce573d82792da8ecb1c69d6f7f081b5452ec45ac57f7527f8d1f500e764736f6c634300081a0033000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000d3c21bcecceda100000000000000000000000000000000000000000000000000000000000000000000167a6b436f64657820546f6b656e204465706c6f7965720000000000000000000000000000000000000000000000000000000000000000000000000000000000075a4b434f44455800000000000000000000000000000000000000000000000000"

                value_in_wei = self.web3.web3.to_wei(0, "ether")

                # Create transaction for gas estimation
                transaction = {
                    "from": self.wallet.address,
                    "to": None,  # Contract creation has no 'to' address
                    "value": value_in_wei,
                    "data": bytecode,
                }

                # Estimate gas
                try:
                    gas_limit = await self.web3.estimate_gas(transaction)
                    transaction["gas"] = gas_limit
                except Exception as gas_error:
                    logger.error(
                        f"[{self.account_index}] Gas estimation error: {gas_error}"
                    )
                    raise gas_error

                # Get gas price parameters
                gas_params = await self.web3.get_gas_params()
                transaction.update(gas_params)

                # Add chain ID and nonce
                transaction["chainId"] = CHAIN_ID
                transaction["nonce"] = await self.web3.web3.eth.get_transaction_count(
                    self.wallet.address
                )

                # Sign transaction
                signed_txn = self.web3.web3.eth.account.sign_transaction(
                    transaction, self.private_key
                )

                # Send transaction
                tx_hash = await self.web3.web3.eth.send_raw_transaction(
                    signed_txn.raw_transaction
                )

                # Wait for confirmation
                receipt = await self.web3.web3.eth.wait_for_transaction_receipt(tx_hash)

                if receipt["status"] == 1:
                    contract_address = receipt.contractAddress
                    logger.success(
                        f"[{self.account_index}] Successfully deployed token contract {contract_address}. TX: {EXPLORER_URL_MEGAETH}{tx_hash.hex()}"
                    )
                    return True, contract_address
                else:
                    logger.error(
                        f"[{self.account_index}] Token contract deployment failed. TX: {EXPLORER_URL_MEGAETH}{tx_hash.hex()}"
                    )
                    return False, None

            except Exception as e:
                random_pause = random.randint(
                    self.config.SETTINGS.RANDOM_PAUSE_BETWEEN_ACTIONS[0],
                    self.config.SETTINGS.RANDOM_PAUSE_BETWEEN_ACTIONS[1],
                )
                logger.error(
                    f"[{self.account_index}] Error deploying token contract: {e}. Pause {random_pause} seconds"
                )
                await asyncio.sleep(random_pause)

        return False, None

    async def deploy_nft(self):
        for retry in range(self.config.SETTINGS.ATTEMPTS):
            try:
                logger.info(f"[{self.account_index}] Deploying NFT contract")

                # NFT contract bytecode
                bytecode = "0x608060405234801561001057600080fd5b5060405161159038038061159083398101604081905261002f916104e0565b8282600061003d83826105da565b50600161004a82826105da565b50505060005b8181101561006a576100623382610073565b600101610050565b50505050610698565b6001600160a01b0382166100a257604051633250574960e11b8152600060048201526024015b60405180910390fd5b60006100af8383836100e1565b90506001600160a01b038116156100dc576040516339e3563760e11b815260006004820152602401610099565b505050565b6000828152600260205260408120546001600160a01b039081169083161561010e5761010e8184866101d9565b6001600160a01b0381161561014b5761012a600085818061023d565b6001600160a01b038116600090815260036020526040902080546000190190555b6001600160a01b0385161561017a576001600160a01b0385166000908152600360205260409020805460010190555b60008481526002602052604080822080546001600160a01b0319166001600160a01b0389811691821790925591518793918516917fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef91a4949350505050565b6101e4838383610362565b6100dc576001600160a01b03831661021257604051637e27328960e01b815260048101829052602401610099565b60405163177e802f60e01b81526001600160a01b038316600482015260248101829052604401610099565b808061025157506001600160a01b03821615155b15610332576000610261846103e8565b90506001600160a01b0383161580159061028d5750826001600160a01b0316816001600160a01b031614155b80156102bf57506001600160a01b0380821660009081526005602090815260408083209387168352929052205460ff16155b156102e85760405163a9fbf51f60e01b81526001600160a01b0384166004820152602401610099565b81156103305783856001600160a01b0316826001600160a01b03167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560405160405180910390a45b505b5050600090815260046020526040902080546001600160a01b0319166001600160a01b0392909216919091179055565b60006001600160a01b038316158015906103e05750826001600160a01b0316846001600160a01b031614806103bc57506001600160a01b0380851660009081526005602090815260408083209387168352929052205460ff165b806103e057506000828152600460205260409020546001600160a01b038481169116145b949350505050565b6000818152600260205260408120546001600160a01b03168061042157604051637e27328960e01b815260048101849052602401610099565b92915050565b634e487b7160e01b600052604160045260246000fd5b600082601f83011261044e57600080fd5b81516001600160401b0381111561046757610467610427565b604051601f8201601f19908116603f011681016001600160401b038111828210171561049557610495610427565b6040528181528382016020018510156104ad57600080fd5b60005b828110156104cc576020818601810151838301820152016104b0565b506000918101602001919091529392505050565b6000806000606084860312156104f557600080fd5b83516001600160401b0381111561050b57600080fd5b6105178682870161043d565b602086015190945090506001600160401b0381111561053557600080fd5b6105418682870161043d565b925050604084015190509250925092565b600181811c9082168061056657607f821691505b60208210810361058657634e487b7160e01b600052602260045260246000fd5b50919050565b601f8211156100dc57806000526020600020601f840160051c810160208510156105b35750805b601f840160051c820191505b818110156105d357600081556001016105bf565b5050505050565b81516001600160401b038111156105f3576105f3610427565b610607816106018454610552565b8461058c565b6020601f82116001811461063b57600083156106235750848201515b600019600385901b1c1916600184901b1784556105d3565b600084815260208120601f198516915b8281101561066b578785015182556020948501946001909201910161064b565b50848210156106895786840151600019600387901b60f8161c191681555b50505050600190811b01905550565b610ee9806106a76000396000f3fe608060405234801561001057600080fd5b50600436106100cf5760003560e01c80636352211e1161008c578063a22cb46511610066578063a22cb465146101b3578063b88d4fde146101c6578063c87b56dd146101d9578063e985e9c5146101ec57600080fd5b80636352211e1461017757806370a082311461018a57806395d89b41146101ab57600080fd5b806301ffc9a7146100d457806306fdde03146100fc578063081812fc14610111578063095ea7b31461013c57806323b872dd1461015157806342842e0e14610164575b600080fd5b6100e76100e2366004610b50565b6101ff565b60405190151581526020015b60405180910390f35b610104610251565b6040516100f39190610bbd565b61012461011f366004610bd0565b6102e3565b6040516001600160a01b0390911681526020016100f3565b61014f61014a366004610c05565b61030c565b005b61014f61015f366004610c2f565b61031b565b61014f610172366004610c2f565b6103ab565b610124610185366004610bd0565b6103cb565b61019d610198366004610c6c565b6103d6565b6040519081526020016100f3565b61010461041e565b61014f6101c1366004610c87565b61042d565b61014f6101d4366004610cd9565b610438565b6101046101e7366004610bd0565b610450565b6100e76101fa366004610dbd565b6104c5565b60006001600160e01b031982166380ac58cd60e01b148061023057506001600160e01b03198216635b5e139f60e01b145b8061024b57506301ffc9a760e01b6001600160e01b03198316145b92915050565b60606000805461026090610df0565b80601f016020809104026020016040519081016040528092919081815260200182805461028c90610df0565b80156102d95780601f106102ae576101008083540402835291602001916102d9565b820191906000526020600020905b8154815290600101906020018083116102bc57829003601f168201915b5050505050905090565b60006102ee826104f3565b506000828152600460205260409020546001600160a01b031661024b565b61031782823361052c565b5050565b6001600160a01b03821661034a57604051633250574960e11b8152600060048201526024015b60405180910390fd5b6000610357838333610539565b9050836001600160a01b0316816001600160a01b0316146103a5576040516364283d7b60e01b81526001600160a01b0380861660048301526024820184905282166044820152606401610341565b50505050565b6103c683838360405180602001604052806000815250610438565b505050565b600061024b826104f3565b60006001600160a01b038216610402576040516322718ad960e21b815260006004820152602401610341565b506001600160a01b031660009081526003602052604090205490565b60606001805461026090610df0565b610317338383610632565b61044384848461031b565b6103a533858585856106d1565b606061045b826104f3565b50600061047360408051602081019091526000815290565b9050600081511161049357604051806020016040528060008152506104be565b8061049d846107fc565b6040516020016104ae929190610e2a565b6040516020818303038152906040525b9392505050565b6001600160a01b03918216600090815260056020908152604080832093909416825291909152205460ff1690565b6000818152600260205260408120546001600160a01b03168061024b57604051637e27328960e01b815260048101849052602401610341565b6103c6838383600161088f565b6000828152600260205260408120546001600160a01b039081169083161561056657610566818486610995565b6001600160a01b038116156105a45761058360008560008061088f565b6001600160a01b038116600090815260036020526040902080546000190190555b6001600160a01b038516156105d3576001600160a01b0385166000908152600360205260409020805460010190555b60008481526002602052604080822080546001600160a01b0319166001600160a01b0389811691821790925591518793918516917fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef91a4949350505050565b6001600160a01b03821661066457604051630b61174360e31b81526001600160a01b0383166004820152602401610341565b6001600160a01b03838116600081815260056020908152604080832094871680845294825291829020805460ff191686151590811790915591519182527f17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c31910160405180910390a3505050565b6001600160a01b0383163b156107f557604051630a85bd0160e11b81526001600160a01b0384169063150b7a0290610713908890889087908790600401610e59565b6020604051808303816000875af192505050801561074e575060408051601f3d908101601f1916820190925261074b91810190610e96565b60015b6107b7573d80801561077c576040519150601f19603f3d011682016040523d82523d6000602084013e610781565b606091505b5080516000036107af57604051633250574960e11b81526001600160a01b0385166004820152602401610341565b805181602001fd5b6001600160e01b03198116630a85bd0160e11b146107f357604051633250574960e11b81526001600160a01b0385166004820152602401610341565b505b5050505050565b60606000610809836109f9565b600101905060008167ffffffffffffffff81111561082957610829610cc3565b6040519080825280601f01601f191660200182016040528015610853576020820181803683370190505b5090508181016020015b600019016f181899199a1a9b1b9c1cb0b131b232b360811b600a86061a8153600a850494508461085d57509392505050565b80806108a357506001600160a01b03821615155b156109655760006108b3846104f3565b90506001600160a01b038316158015906108df5750826001600160a01b0316816001600160a01b031614155b80156108f257506108f081846104c5565b155b1561091b5760405163a9fbf51f60e01b81526001600160a01b0384166004820152602401610341565b81156109635783856001600160a01b0316826001600160a01b03167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560405160405180910390a45b505b5050600090815260046020526040902080546001600160a01b0319166001600160a01b0392909216919091179055565b6109a0838383610ad1565b6103c6576001600160a01b0383166109ce57604051637e27328960e01b815260048101829052602401610341565b60405163177e802f60e01b81526001600160a01b038316600482015260248101829052604401610341565b60008072184f03e93ff9f4daa797ed6e38ed64bf6a1f0160401b8310610a385772184f03e93ff9f4daa797ed6e38ed64bf6a1f0160401b830492506040015b6d04ee2d6d415b85acef81000000008310610a64576d04ee2d6d415b85acef8100000000830492506020015b662386f26fc100008310610a8257662386f26fc10000830492506010015b6305f5e1008310610a9a576305f5e100830492506008015b6127108310610aae57612710830492506004015b60648310610ac0576064830492506002015b600a831061024b5760010192915050565b60006001600160a01b03831615801590610b2f5750826001600160a01b0316846001600160a01b03161480610b0b5750610b0b84846104c5565b80610b2f57506000828152600460205260409020546001600160a01b038481169116145b949350505050565b6001600160e01b031981168114610b4d57600080fd5b50565b600060208284031215610b6257600080fd5b81356104be81610b37565b60005b83811015610b88578181015183820152602001610b70565b50506000910152565b60008151808452610ba9816020860160208601610b6d565b601f01601f19169290920160200192915050565b6020815260006104be6020830184610b91565b600060208284031215610be257600080fd5b5035919050565b80356001600160a01b0381168114610c0057600080fd5b919050565b60008060408385031215610c1857600080fd5b610c2183610be9565b946020939093013593505050565b600080600060608486031215610c4457600080fd5b610c4d84610be9565b9250610c5b60208501610be9565b929592945050506040919091013590565b600060208284031215610c7e57600080fd5b6104be82610be9565b60008060408385031215610c9a57600080fd5b610ca383610be9565b915060208301358015158114610cb857600080fd5b809150509250929050565b634e487b7160e01b600052604160045260246000fd5b60008060008060808587031215610cef57600080fd5b610cf885610be9565b9350610d0660208601610be9565b925060408501359150606085013567ffffffffffffffff811115610d2957600080fd5b8501601f81018713610d3a57600080fd5b803567ffffffffffffffff811115610d5457610d54610cc3565b604051601f8201601f19908116603f0116810167ffffffffffffffff81118282101715610d8357610d83610cc3565b604052818152828201602001891015610d9b57600080fd5b8160208401602083013760006020838301015280935050505092959194509250565b60008060408385031215610dd057600080fd5b610dd983610be9565b9150610de760208401610be9565b90509250929050565b600181811c90821680610e0457607f821691505b602082108103610e2457634e487b7160e01b600052602260045260246000fd5b50919050565b60008351610e3c818460208801610b6d565b835190830190610e50818360208801610b6d565b01949350505050565b6001600160a01b0385811682528416602082015260408101839052608060608201819052600090610e8c90830184610b91565b9695505050505050565b600060208284031215610ea857600080fd5b81516104be81610b3756fea2646970667358221220ccab840784ef52d6b399174e2f2d31e294dd5697a225b1ecdf9502c952f9d66f64736f6c634300081a0033000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000147a6b436f646578204e4654204465706c6f79657200000000000000000000000000000000000000000000000000000000000000000000000000000000000000075a4b434f44455800000000000000000000000000000000000000000000000000"

                value_in_wei = self.web3.web3.to_wei(0, "ether")

                # Create transaction for gas estimation
                transaction = {
                    "from": self.wallet.address,
                    "to": None,  # Contract creation has no 'to' address
                    "value": value_in_wei,
                    "data": bytecode,
                }

                # Estimate gas
                try:
                    gas_limit = await self.web3.estimate_gas(transaction)
                    transaction["gas"] = gas_limit
                except Exception as gas_error:
                    logger.error(
                        f"[{self.account_index}] Gas estimation error: {gas_error}"
                    )
                    raise gas_error

                # Get gas price parameters
                gas_params = await self.web3.get_gas_params()
                transaction.update(gas_params)

                # Add chain ID and nonce
                transaction["chainId"] = CHAIN_ID
                transaction["nonce"] = await self.web3.web3.eth.get_transaction_count(
                    self.wallet.address
                )

                # Sign transaction
                signed_txn = self.web3.web3.eth.account.sign_transaction(
                    transaction, self.private_key
                )

                # Send transaction
                tx_hash = await self.web3.web3.eth.send_raw_transaction(
                    signed_txn.raw_transaction
                )

                # Wait for confirmation
                receipt = await self.web3.web3.eth.wait_for_transaction_receipt(tx_hash)

                if receipt["status"] == 1:
                    contract_address = receipt.contractAddress
                    logger.success(
                        f"[{self.account_index}] Successfully deployed NFT contract {contract_address}. TX: {EXPLORER_URL_MEGAETH}{tx_hash.hex()}"
                    )
                    return True, contract_address
                else:
                    logger.error(
                        f"[{self.account_index}] NFT contract deployment failed. TX: {EXPLORER_URL_MEGAETH}{tx_hash.hex()}"
                    )
                    return False, None

            except Exception as e:
                random_pause = random.randint(
                    self.config.SETTINGS.RANDOM_PAUSE_BETWEEN_ACTIONS[0],
                    self.config.SETTINGS.RANDOM_PAUSE_BETWEEN_ACTIONS[1],
                )
                logger.error(
                    f"[{self.account_index}] Error deploying NFT contract: {e}. Pause {random_pause} seconds"
                )
                await asyncio.sleep(random_pause)

        return False, None

    async def deploy(self):
        try:
            # Collect all enabled actions
            enabled_actions = []

            if self.config.DEPLOY.ZKCODEX.DEPLOY_TOKEN:
                enabled_actions.append(self.deploy_token)

            if self.config.DEPLOY.ZKCODEX.DEPLOY_NFT:
                enabled_actions.append(self.deploy_nft)

            if self.config.DEPLOY.ZKCODEX.DEPLOY_CONTRACT:
                enabled_actions.append(self.deploy_default_contract)

            # If no actions are enabled, return
            if not enabled_actions:
                logger.info(
                    f"[{self.account_index}] No actions enabled in config for ZkCodex"
                )
                return False

            # Shuffle to randomize order
            random.shuffle(enabled_actions)

            # Execute actions based on config
            if self.config.DEPLOY.ZKCODEX.ONE_ACTION_PER_LAUNCH:
                # Run just one random action
                action = random.choice(enabled_actions)
                logger.info(
                    f"[{self.account_index}] Running one random action: {action.__name__}"
                )
                result, _ = await action()
                return result
            else:
                # Run all enabled actions in random order
                logger.info(
                    f"[{self.account_index}] Running all enabled actions in random order"
                )
                success = True
                for action in enabled_actions:
                    logger.info(
                        f"[{self.account_index}] Running action: {action.__name__}"
                    )
                    result, _ = await action()
                    if not result:
                        success = False
                return success

        except Exception as err:
            logger.error(f"[{self.account_index}] ZkCodex deploy failed: {err}")
            return False
